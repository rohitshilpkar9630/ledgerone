<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LedgerOne — Debug</title>
  <link rel="stylesheet" href="../css/theme.css"/>
  <style>
    body{font-family:Inter,system-ui;background:linear-gradient(180deg,#071017,#0b1014);color:var(--text);padding:20px}
    .wrap{max-width:900px;margin:0 auto}
    h1{color:var(--accent)}
    .grid{display:grid;grid-template-columns:1fr 280px;gap:18px}
    .box{background:var(--card);padding:14px;border-radius:12px;border:var(--glass-border);box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    pre{white-space:pre-wrap;color:var(--muted);font-size:13px}
    button{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:none;color:#0b0b0b;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .muted{color:var(--muted);font-size:13px}
    .ok{color:var(--ok)}
    .bad{color:var(--danger)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>LedgerOne — Auth & Persistence Debug</h1>
    <p class="muted">Use this page to confirm Supabase sessions are being stored and a user is signed in. Run the checks after attempting signup/login.</p>

    <div style="display:flex;gap:12px;margin-bottom:12px">
      <button id="btnFull" title="Run full check">Run full 1-click check</button>
      <button id="btnClear" title="Clear stored debug keys">Clear debug localStorage</button>
      <div style="flex:1"></div>
      <div class="muted">Server origin: <strong id="origin"></strong></div>
    </div>

    <div class="grid">
      <div class="box">
        <div><strong>1) Supabase session (getSession)</strong></div>
        <pre id="outSession">(not run)</pre>
      </div>

      <div class="box">
        <div><strong>2) localStorage keys</strong></div>
        <pre id="outLocal">(not run)</pre>
      </div>

      <div class="box">
        <div><strong>3) Auth getUser()</strong></div>
        <pre id="outUser">(not run)</pre>
      </div>

      <div class="box">
        <div><strong>4) Auth REST check</strong></div>
        <pre id="outNet">(not run)</pre>
      </div>

      <div class="box">
        <div><strong>5) Supabase Auth → Users (via admin endpoint)</strong></div>
        <pre id="outUsers">(not run)</pre>
        <div class="muted" style="margin-top:8px">Note: this call will succeed only if a valid anon token is present and your DB allows the query. It's for debugging.</div>
      </div>

      <div class="box">
        <div><strong>6) Quick checklist</strong></div>
        <pre id="outChecklist">Click "Run full 1-click check"</pre>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from '../js/supabase.js';

    document.getElementById('origin').textContent = location.origin;

    const outSession = document.getElementById('outSession');
    const outLocal = document.getElementById('outLocal');
    const outUser = document.getElementById('outUser');
    const outNet = document.getElementById('outNet');
    const outUsers = document.getElementById('outUsers');
    const outChecklist = document.getElementById('outChecklist');

    async function runChecks(){
      outChecklist.textContent = 'Running tests...';
      try{
        // 1) getSession
        const sess = await supabase.auth.getSession();
        outSession.textContent = JSON.stringify(sess, null, 2);

        // 2) localStorage snapshot
        const keys = {};
        for(let i=0;i<localStorage.length;i++){
          const k = localStorage.key(i);
          keys[k] = localStorage.getItem(k);
        }
        outLocal.textContent = JSON.stringify(keys, null, 2).slice(0,5000);

        // 3) getUser
        try{
          const user = await supabase.auth.getUser();
          outUser.textContent = JSON.stringify(user, null, 2);
        }catch(e){
          outUser.textContent = 'Error: ' + e.message;
        }

        // 4) REST /auth/v1/user (uses access token if present)
        try{
          const access = sess?.data?.session?.access_token || '';
          const url = (supabase && supabase.url) ? `${supabase.url}/auth/v1/user` : 'UNKNOWN_URL';
          const resp = await fetch(url, { method:'GET', headers: { Authorization: 'Bearer ' + access }});
          const txt = await resp.text();
          outNet.textContent = `status: ${resp.status}\n\n${txt}`;
        }catch(e){
          outNet.textContent = 'Error: ' + (e.message || e);
        }

        // 5) Attempt to query a simple table (products) to confirm anon key
        try{
          const { data, error } = await supabase.from('products').select('id,name').limit(5);
          outUsers.textContent = JSON.stringify({data,error}, null, 2);
        }catch(e){
          outUsers.textContent = 'Error: ' + e.message;
        }

        // 6) Checklist guidance
        let checklist = [];
        checklist.push('1. Serving via HTTP? ' + (location.protocol.startsWith('http') ? 'OK' : 'NO (use Live Server)'));
        checklist.push('2. Supabase client url: ' + (supabase?.url || 'NOT FOUND'));
        checklist.push('3. Session present? ' + (sess?.data?.session ? 'YES' : 'NO'));
        checklist.push('4. localStorage tokens present? ' + ((localStorage.getItem('ledgerone.auth') || localStorage.getItem('supabase.auth.token')) ? 'YES' : 'NO'));
        checklist.push('5. Auth user object present? ' + ((await supabase.auth.getUser()).data?.user ? 'YES' : 'NO'));
        checklist.push('6. If (3)==NO then: check Supabase Auth settings (Site URL + Redirect URLs) and Email confirmation');
        outChecklist.textContent = checklist.join('\\n');

      }catch(e){
        console.error(e);
        outChecklist.textContent = 'Fatal error: ' + e.message;
      }
    }

    document.getElementById('btnFull').addEventListener('click', runChecks);
    document.getElementById('btnClear').addEventListener('click', () => {
      if(confirm('Clear localStorage keys? This will sign you out locally.')) {
        localStorage.removeItem('ledgerone.auth');
        localStorage.removeItem('supabase.auth.token');
        runChecks();
      }
    });

    // auto-run on page load (optional)
    // runChecks();
  </script>
</body>
</html>
